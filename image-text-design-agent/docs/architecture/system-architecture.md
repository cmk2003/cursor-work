# 系统架构设计

## 1. 总体架构

### 1.1 架构概览

系统采用微服务架构，分为三大核心层：

```
┌─────────────────────────────────────────────────────────────┐
│                      前端展示层                              │
│  ┌─────────┐ ┌──────────┐ ┌─────────┐ ┌──────────┐        │
│  │用户管理  │ │项目管理   │ │灵感广场 │ │LUI交互   │        │
│  └─────────┘ └──────────┘ └─────────┘ └──────────┘        │
│  ┌─────────┐ ┌──────────┐ ┌─────────┐                     │
│  │画布编辑  │ │结果展示   │ │通知系统 │                     │
│  └─────────┘ └──────────┘ └─────────┘                     │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      服务端中间层                            │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                   API Gateway                        │   │
│  │         (路由/鉴权/限流/负载均衡)                    │   │
│  └─────────────────────────────────────────────────────┘   │
│                              │                              │
│  ┌─────────┐ ┌──────────┐ ┌─────────┐ ┌──────────┐       │
│  │用户服务  │ │项目服务   │ │任务服务 │ │素材服务   │       │
│  └─────────┘ └──────────┘ └─────────┘ └──────────┘       │
│  ┌──────────────────────┐ ┌─────────────────────┐         │
│  │   算法调度服务        │ │   状态管理服务      │         │
│  └──────────────────────┘ └─────────────────────┘         │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      算法智能层                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │               LangGraph 工作流引擎                   │   │
│  │  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐      │   │
│  │  │意图理解│ │风格分析│ │图像生成│ │质量优化│      │   │
│  │  └────────┘ └────────┘ └────────┘ └────────┘      │   │
│  └─────────────────────────────────────────────────────┘   │
│  ┌─────────┐ ┌──────────┐ ┌─────────┐ ┌──────────┐       │
│  │LLM服务  │ │生图模型   │ │OCR服务  │ │图像处理   │       │
│  └─────────┘ └──────────┘ └─────────┘ └──────────┘       │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      基础设施层                              │
│  ┌─────────┐ ┌──────────┐ ┌─────────┐ ┌──────────┐       │
│  │MySQL    │ │Redis     │ │Kafka    │ │OSS存储    │       │
│  └─────────┘ └──────────┘ └─────────┘ └──────────┘       │
│  ┌──────────────────────┐ ┌─────────────────────┐         │
│  │   Kubernetes集群     │ │   监控告警系统      │         │
│  └──────────────────────┘ └─────────────────────┘         │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 核心设计原则

1. **高可用性**：服务无状态化设计，支持水平扩展
2. **解耦合**：通过消息队列实现异步处理，降低服务间耦合
3. **可观测性**：完善的日志、监控、链路追踪体系
4. **安全性**：多层安全防护，包括API鉴权、数据加密、访问控制
5. **用户体验**：响应式设计，支持实时反馈和进度展示

## 2. 数据流设计

### 2.1 同步请求流程（CRUD操作）

```
用户 → 前端 → API Gateway → 业务服务 → 数据库
                    ↓
                 响应返回
```

### 2.2 异步生成流程（LUI请求）

```
用户输入 → 前端提交
            ↓
       API Gateway
            ↓
       任务服务创建任务
            ↓
       消息队列(Kafka)
            ↓
       算法调度服务
            ↓
    LangGraph工作流执行
            ↓
       生成结果存储
            ↓
    WebSocket推送/轮询
            ↓
       前端展示结果
```

## 3. 关键技术决策

### 3.1 前端技术选型

- **Vue 3**：组件化开发，响应式数据绑定
- **TypeScript**：类型安全，提升代码质量
- **Fabric.js**：强大的Canvas库，支持复杂图形编辑
- **WebSocket**：实时通信，推送生成进度

### 3.2 后端技术选型

- **Go**：高性能，适合构建API网关和高并发服务
- **Python**：丰富的AI生态，适合算法调度
- **gRPC**：服务间高效通信
- **JWT**：无状态认证方案

### 3.3 算法技术选型

- **LangGraph**：构建可追踪、可调试的AI工作流
- **Stable Diffusion**：开源生图模型，可私有化部署
- **PaddleOCR**：中文OCR识别，确保文字正确性
- **CLIP**：图文匹配，评估生成质量

## 4. 扩展性设计

### 4.1 水平扩展

- 无状态服务设计，支持动态扩缩容
- 数据库读写分离，支持分库分表
- 缓存层支持分布式部署

### 4.2 功能扩展

- 插件化的算法节点，便于添加新功能
- 模板系统支持自定义扩展
- API版本管理，向后兼容

## 5. 安全设计

### 5.1 访问控制

- API Gateway统一鉴权
- RBAC权限模型
- 敏感操作二次验证

### 5.2 数据安全

- HTTPS传输加密
- 敏感数据加密存储
- 定期安全审计

### 5.3 内容安全

- 图像内容审核
- 文本敏感词过滤
- 用户行为监控

## 6. 性能优化

### 6.1 前端优化

- 懒加载和代码分割
- 图片CDN加速
- 本地缓存策略

### 6.2 后端优化

- 接口响应缓存
- 数据库查询优化
- 连接池管理

### 6.3 算法优化

- GPU资源池化
- 模型推理优化
- 批处理提升吞吐量